<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Takes is a pure object-oriented and immutable Java web framework that turns the design and development of web applications into a pleasant and fun process." /> <meta name="keywords" content="best java web framework, java web app framework, java web development framework, java web framework, object-oriented java web framework" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="article:published_time" content="2015-03-22 00:00:00 +0000"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Java Web App Architecture In Takes Framework"/> <meta name="twitter:description" property="og:description" content="Takes is a pure object-oriented and immutable Java web framework that turns the design and development of web applications into a pleasant and fun process."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/2015/03/22/takes-java-web-framework.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?9fa700503fd"/> <link rel="apple-touch-icon" href="/favicon.ico?9fa700503fd"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?9fa700503fd"/> <link rel="stylesheet" href="/css/icons.css?9fa700503fd"/> <link rel="canonical" href="https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" /> <title>Java Web App Architecture In Takes Framework </title> <meta name='og:image' content='https://www.yegor256.com/images/2015/03/godfather-shooting-scene.jpg'/><meta name='twitter:image' content='https://www.yegor256.com/images/2015/03/godfather-shooting-scene.jpg'/><meta name='og:image:width' content='1000'/> <meta name='twitter:image:width' content='1000'/><meta name='og:image:height' content='583'/> <meta name='twitter:image:height' content='583'/><meta name='twitter:card' content='summary_large_image'/><meta name='twitter:image:alt' content='Making of The Godfather (1972) by Francis Ford Coppola'/> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My StackOverflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;326</a></li> <li ><a href="/webinars.html" title="My webinars">Webinars</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li class="highlighted"><a href="/trainings.html" title="On-site trainings">Trainings</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке">По-русски</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul> <li> At <a href="/webinars.html">Webinar #47</a> we will discuss Aspect Oriented Programming (its pros and cons), join us on <b>November 6</b>, at 11am PST. </li> <li> I have a limited job offer for you, if you are a Java developer and you live in Moscow, Russia. It's a full-time job in a large Fortune-100 company, which is attempting to get into the open source marketplace and we are here to help them. Here is the <a href="/pdf/job-description.pdf">job description</a>, <a href="mailto:job@yegor256.com">email me</a> if interested, ASAP. </li></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><p class="printable"> <img src="https://api.qrserver.com/v1/create-qr-code/?data=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html&amp;format=svg" style="width:125px;height:125px;" alt="QR code"/></p><p class="printable"> <code itemprop="url">https://www.yegor256.com/2015/03/22/takes-java-web-framework.html</code></p><h1 itemprop="name headline mainEntityOfPage">Java Web App Architecture In Takes Framework</h1><ul class="subline"> <li> <time itemprop="datePublished" datetime="2015-03-22T00:00:00+00:00"> 22 March 2015 </time> </li> <li class="printable" itemscope="" itemprop="author" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </li> <li class="unprintable"> <i class="icon icon-comments"></i> <a href="http://www.yegor256.com/2015/03/22/takes-java-web-framework.html#disqus_thread" itemprop="discussionUrl">comments</a> </li></ul><p class="unprintable"><a href='/tag/java.html' class='tag notranslate'><img src='/images/java-icon.svg' alt='Java'/>java</a> <a href='/tag/pets.html' class='tag notranslate'>pets</a></p><nav class="buttons notranslate desktop-only"> <a href="http://www.facebook.com/sharer/sharer.php?u=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" title="Share on Facebook" class="button" rel="nofollow"> <span class="count count-facebook">0</span> <i class="icon icon-facebook notranslate" aria-hidden="true"></i> </a> <a href="https://twitter.com/share?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html&amp;text=Java+Web+App+Architecture+In+Takes+Framework" title="Share on Twitter" class="button" rel="nofollow"> <span class="count count-twitter">0</span> <i class="icon icon-twitter notranslate" aria-hidden="true"></i> </a> <a href="https://www.linkedin.com/cws/share?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html" title="Share on LinkedIn" class="button" rel="nofollow"> <span class="count count-linkedin">0</span> <i class="icon icon-linkedin notranslate" aria-hidden="true"></i> </a> <a href="http://reddit.com/submit?url=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html%3F2015-12&amp;title=Java+Web+App+Architecture+In+Takes+Framework" title="Share on Reddit" class="button" rel="nofollow"> <span class="count count-reddit">0</span> <i class="icon icon-reddit notranslate" aria-hidden="true"></i> </a> <a href="http://news.ycombinator.com/submitlink?u=https://www.yegor256.com/2015/03/22/takes-java-web-framework.html%3F2015-12&amp;t=Java+Web+App+Architecture+In+Takes+Framework" title="Share on Hacker News" class="button" rel="nofollow"> <span class="count count-hackernews">0</span> <i class="icon icon-hackernews notranslate" aria-hidden="true"></i> </a> </nav> </header> <article class="main" itemprop="articleBody"><div ><p>I used to utilize Servlets, JSP, JAX-RS, Spring Framework, Play Framework, JSF with Facelets, and a bit of Spark Framework. All of these solutions, in my humble opinion, are very far from being object-oriented and elegant. They all are full of static methods, un-testable data structures, and dirty hacks. So about a month ago, I decided to create my own Java web framework. I put a few basic principles into its foundation: 1) No <a href="/2014/05/13/why-null-is-bad.html">NULLs</a>, 2) no public <a href="/2014/05/05/oop-alternative-to-utility-classes.html">static</a> methods, 3) no <a href="/2014/06/09/objects-should-be-immutable.html">mutable</a> classes, and 4) no class casting, reflection, and <a href="/2015/04/02/class-casting-is-anti-pattern.html"><code>instanceof</code></a> operators. These four basic principles should guarantee clean code and transparent architecture. That’s how the <a href="http://www.takes.org">Takes</a> framework was born. Let’s see what was created and how it works.</p><figure class="jb_picture"><img itemprop="image" alt="Making of The Godfather (1972) by Francis Ford Coppola" src="/images/2015/03/godfather-shooting-scene.jpg" longdesc="#9fedcf46" /><figcaption id="9fedcf46">Making of The Godfather (1972) by Francis Ford Coppola</figcaption></figure><h2 id="java-web-architecture-in-a-nutshell">Java Web Architecture in a Nutshell</h2><p>This is how I understand a web application architecture and its components, in simple terms.</p><aside class="youtube"> <a href="https://www.youtube.com/watch?v=nheD2LNYrpk"><div class="box"> <img src="https://i.ytimg.com/vi/nheD2LNYrpk/mqdefault.jpg" alt="YouTube video #nheD2LNYrpk" /><div class="play"><i class="icon icon-play"></i></div></div></a><div>Takes, Java Web Framework, Intro (webinar #12); 2 March 2016.</div></aside><p>First, to create a web server, we should create a new <a href="http://en.wikipedia.org/wiki/Network_socket">network socket</a>, that accepts connections on a certain <a href="http://en.wikipedia.org/wiki/Port_%28computer_networking%29">TCP port</a>. Usually it is 80, but I’m going to use 8080 for testing purposes. This is done in Java with the <a href="http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html"><code>ServerSocket</code></a> class:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>That’s enough to start a web server. Now, the socket is ready and listening on port 8080. When someone opens <code>http://localhost:8080</code> in their browser, the connection will be established and the browser will spin its waiting wheel forever. Compile this snippet and try. We just built a simple web server without the use of any frameworks. We’re not doing anything with incoming connections yet, but we’re not rejecting them either. All of them are being lined up inside that <code>server</code> object. It’s being done in a background thread; that’s why we need to put that <code>while(true)</code> in afterward. Without this endless pause, the app will finish its execution immediately and the server socket will shut down.</p><p>The next step is to accept the incoming connections. In Java, that’s done through a blocking call to the <code>accept()</code> method:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span></code></pre></figure><p>The method is blocking its thread and waiting until a new connection arrives. As soon as that happens, it returns an instance of <code>Socket</code>. In order to accept the next connection, we should call <code>accept()</code> again. So basically, our web server should work like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
      <span class="c1">// 1. Read HTTP request from the socket</span>
      <span class="c1">// 2. Prepare an HTTP response</span>
      <span class="c1">// 3. Send HTTP response to the socket</span>
      <span class="c1">// 4. Close the socket</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>It’s an endless cycle that accepts a new connection, understands it, creates a response, returns the response, and accepts a new connection again. HTTP protocol is stateless, which means the server should not remember what happened in any previous connection. All it cares about is the incoming HTTP request in this particular connection.</p><p>The HTTP request is coming from the input stream of the socket and looks like a multi-line block of text. This is what you would see if you read an input stream of the socket:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">BufferedReader</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">InputStreamReader</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">())</span>
<span class="o">);</span>
<span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
  <span class="kd">final</span> <span class="n">String</span> <span class="n">line</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="na">readLine</span><span class="o">();</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>
  <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">line</span><span class="o">);</span>
<span class="o">}</span></code></pre></figure><p>You will see something like this:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>GET / HTTP/1.1
Host: localhost:8080
Connection: keep-alive
Cache-Control: max-age=0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2272.89 Safari/537.36
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en;q=0.8,ru;q=0.6,uk;q=0.4</code></pre></figure><p>The client (the Google Chrome browser, for example) passes this text into the connection established. It connects to port 8080 at <code>localhost</code>, and as soon as the connection is ready, it immediately sends this text into it, then waits for a response.</p><p>Our job is to create an HTTP response using the information we get in the request. If our server is very primitive, we can basically ignore all the information in the request and just return “Hello, world!” to all requests (I’m using <a href="https://commons.apache.org/proper/commons-io/javadocs/api-2.5/org/apache/commons/io/IOUtils.html"><code>IOUtils</code></a> for simplicity):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="mi">8080</span><span class="o">);</span>
    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">(</span><span class="kd">final</span> <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">IOUtils</span><span class="o">.</span><span class="na">copy</span><span class="o">(</span>
          <span class="n">IOUtils</span><span class="o">.</span><span class="na">toInputStream</span><span class="o">(</span><span class="s">&quot;HTTP/1.1 200 OK\r\n\r\nHello, world!&quot;</span><span class="o">),</span>
          <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">()</span>
        <span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>That’s it. The server is ready. Try to compile and run it. Point your browser to <code>http://localhost:8080</code>, and you will see <code>Hello, world!</code>:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ javac -cp commons-io.jar Foo.java
$ java -cp commons-io.jar:. Foo <span class="p">&amp;</span>
$ curl http://localhost:8080 -v
* Rebuilt URL to: http://localhost:8080/
* Connected to localhost <span class="o">(</span>::1<span class="o">)</span> port <span class="m">8080</span> <span class="o">(</span><span class="c1">#0)</span>
&gt; GET / HTTP/1.1
&gt; User-Agent: curl/7.37.1
&gt; Host: localhost:8080
&gt; Accept: */*
&gt;
&lt; HTTP/1.1 <span class="m">200</span> OK
* no chunk, no close, no size. Assume close to signal end
&lt;
* Closing connection <span class="m">0</span>
Hello, world!</code></pre></figure><p>That’s all you need to build a web server. Now let’s discuss how to make it object-oriented and composable. Let’s try to see how the <a href="http://www.takes.org">Takes</a> framework was built.</p><h2 id="routingdispatching">Routing/Dispatching</h2><p>Routing/dispatching is combined with response printing in Takes. All you need to do to create a working web application is to create a single class that implements <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Take.html"><code>Take</code></a> interface:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Request</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkFoo</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">route</span><span class="o">(</span><span class="kd">final</span> <span class="n">Request</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsText</span><span class="o">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>And now it’s time to start a server:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtBasic</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtBasic</span><span class="o">(</span><span class="k">new</span> <span class="n">TkFoo</span><span class="o">(),</span> <span class="mi">8080</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html"><code>FtBasic</code></a> class does the exact same socket manipulations explained above. It starts a server socket on port 8080 and dispatches all incoming connections through an instance of <code>TkFoo</code> that we are giving to its constructor. It does this dispatching in an endless cycle, checking every second whether it’s time to stop with an instance of <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/Exit.html"><code>Exit</code></a>. Obviously, <code>Exit.NEVER</code> always responds with, “Don’t stop, please.”</p><h2 id="http-request">HTTP Request</h2><p>Now let’s see what’s inside the HTTP request arriving at <code>TkFoo</code> and what we can get out of it. This is how the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a> interface is defined in <a href="http://www.takes.org">Takes</a>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Request</span> <span class="o">{</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">head</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
  <span class="n">InputStream</span> <span class="nf">body</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>The request is divided into two parts: the head and the body. The head contains all lines that go before the empty line that starts a body, according to HTTP specification in <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec5.html">RFC 2616</a>. There are many useful decorators for <code>Request</code> in the framework. For example, <code>RqMethod</code> will help you get the method name from the first line of the header:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqMethod</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">method</span><span class="o">();</span></code></pre></figure><p><code>RqHref</code> will help extract the query part and parse it. For example, this is the request:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">GET</span> <span class="o">/</span><span class="n">user</span><span class="o">?</span><span class="n">id</span><span class="o">=</span><span class="mi">123</span> <span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="nl">Host:</span> <span class="n">www</span><span class="o">.</span><span class="na">example</span><span class="o">.</span><span class="na">com</span></code></pre></figure><p>This code will extract that <code>123</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">parseInt</span><span class="o">(</span>
  <span class="k">new</span> <span class="n">RqHref</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">href</span><span class="o">().</span><span class="na">param</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
<span class="o">);</span></code></pre></figure><p><code>RqPrint</code> can get the entire request or its body printed as a <code>String</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RqPrint</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="na">printBody</span><span class="o">();</span></code></pre></figure><p>The idea here is to keep the <code>Request</code> interface simple and provide this request parsing functionality to its decorators. This approach helps the framework keep classes small and cohesive. Each decorator is very small and solid, doing exactly one thing. All of these decorators are in the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rq/package-summary.html"><code>org.takes.rq</code></a> package. As you already probably understand, the <code>Rq</code> prefix stands for <code>Request</code>.</p><h2 id="first-real-web-app">First Real Web App</h2><p>Let’s create our first real web application, which will do something useful. I would recommend starting with an <code>Entry</code> class, which is required by Java to start an app from the command line:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.http.Exit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.http.FtCli</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>This class contains just a single <code>main()</code> static method that will be called by JVM when the app starts from the command line. As you see, it instantiates <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtCli.html"><code>FtCli</code></a>, giving it an instance of class <code>TkApp</code> and command line arguments. We’ll create the <code>TkApp</code> class in a second. <code>FtCli</code> (translates to “front-end with command line interface”) makes an instance of the same <code>FtBasic</code>, wrapping it into a few useful decorators and configuring it according to command line arguments. For example, <code>--port=8080</code> will be converted into a <code>8080</code> port number and passed as a second argument of the <code>FtBasic</code> constructor.</p><p>The web application itself is called <code>TkApp</code> and extends <code>TsWrap</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.takes.Take</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.facets.fork.FkRegex</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.facets.fork.TkFork</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkWrap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.takes.tk.TkClasspath</span><span class="o">;</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="n">TkApp</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">TkApp</span><span class="o">.</span><span class="na">make</span><span class="o">());</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/robots.txt&quot;</span><span class="o">,</span> <span class="s">&quot;&quot;</span><span class="o">),</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/css/.*&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkClasspath</span><span class="o">()),</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkIndex</span><span class="o">())</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>We’ll discuss this <code>TkFork</code> class in a minute.</p><p>If you’re using Maven, this is the <code>pom.xml</code> you should start with:</p><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0&quot;</span>
  <span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
  <span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://maven.apache.org/POM/4.0.0</span>
<span class="s">    http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>foo<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>foo<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;dependencies&gt;</span>
    <span class="nt">&lt;dependency&gt;</span>
      <span class="nt">&lt;groupId&gt;</span>org.takes<span class="nt">&lt;/groupId&gt;</span>
      <span class="nt">&lt;artifactId&gt;</span>takes<span class="nt">&lt;/artifactId&gt;</span>
      <span class="nt">&lt;version&gt;</span>0.9<span class="nt">&lt;/version&gt;</span> <span class="c">&lt;!-- check the latest in Maven Central --&gt;</span>
    <span class="nt">&lt;/dependency&gt;</span>
  <span class="nt">&lt;/dependencies&gt;</span>
  <span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;finalName&gt;</span>foo<span class="nt">&lt;/finalName&gt;</span>
    <span class="nt">&lt;plugins&gt;</span>
      <span class="nt">&lt;plugin&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>maven-dependency-plugin<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;executions&gt;</span>
          <span class="nt">&lt;execution&gt;</span>
            <span class="nt">&lt;goals&gt;</span>
              <span class="nt">&lt;goal&gt;</span>copy-dependencies<span class="nt">&lt;/goal&gt;</span>
            <span class="nt">&lt;/goals&gt;</span>
            <span class="nt">&lt;configuration&gt;</span>
              <span class="nt">&lt;outputDirectory&gt;</span>${project.build.directory}/deps<span class="nt">&lt;/outputDirectory&gt;</span>
            <span class="nt">&lt;/configuration&gt;</span>
          <span class="nt">&lt;/execution&gt;</span>
        <span class="nt">&lt;/executions&gt;</span>
      <span class="nt">&lt;/plugin&gt;</span>
    <span class="nt">&lt;/plugins&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
<span class="nt">&lt;/project&gt;</span></code></pre></figure><p>Running <code>mvn clean package</code> should build a <code>foo.jar</code> file in <code>target</code> directory and a collection of all JAR dependencies in <code>target/deps</code>. Now you can run the app from the command line:</p><figure class="highlight"><pre><code class="language-bash" data-lang="bash"><span></span>$ mvn clean package
$ java -Dfile.encoding<span class="o">=</span>UTF-8 <span class="se">\</span>
  -cp ./target/foo.jar:./target/deps/* foo.Entry --port<span class="o">=</span><span class="m">8080</span></code></pre></figure><p>The application is ready, and you can deploy it to, say, Heroku. Just create a <code>Procfile</code> file in the root of the repository and push the repo to Heroku. This is what <code>Procfile</code> should look like:</p><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>web: java -Dfile.encoding=UTF-8 \
  -cp target/foo.jar:target/deps/* \
  foo.Entry --port=${PORT}</code></pre></figure><h2 id="tkfork"><code>TkFork</code></h2><p>This <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/TkFork.html"><code>TkFork</code></a> class seems to be one of the core elements of the framework. It helps route an incoming HTTP request to the right <em>take</em>. Its logic is very simple, and there are just a few lines of code inside it. It encapsulates a collection of “forks,” which are instances of the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/fork/Fork.html"><code>Fork</code></a> interface:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Fork</span> <span class="o">{</span>
  <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="n">Request</span> <span class="n">req</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>Its only <code>route()</code> method either returns an empty iterator or an iterator with a single <code>Response</code>. <code>TkFork</code> goes through all forks, calling their <code>route()</code> methods until one of them returns a response. Once that happens, <code>TkFork</code> returns this response to the caller, which is <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtBasic.html"><code>FtBasic</code></a>.</p><p>Let’s create a simple fork ourselves now. For example, we want to show the status of the application when the <code>/status</code> URL is requested. Here is the code:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">Fork</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="nf">route</span><span class="o">(</span><span class="n">Request</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
          <span class="kd">final</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span> <span class="n">responses</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">1</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="k">new</span> <span class="n">RqHref</span><span class="o">(</span><span class="n">req</span><span class="o">).</span><span class="na">href</span><span class="o">().</span><span class="na">path</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;/status&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">responses</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">TkStatus</span><span class="o">());</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="n">responses</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>I believe the logic here is clear. We either return an empty iterator or an iterator with an instance of <code>TkStatus</code> inside. If an empty iterator is returned, <code>TkFork</code> will try to find another fork in the collection that actually gets an instance of <code>Response</code>. By the way, if nothing is found and all forks return empty iterators, <code>TkFork</code> will throw a “Page not found” exception.</p><p>This exact logic is implemented by an out-of-the-box fork called <code>FkRegex</code>, which attempts to match a request URI path with the regular expression provided:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/status&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatus</span><span class="o">())</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>We can compose a multi-level structure of <code>TkFork</code> classes; for example:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TsWrap</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span>
        <span class="s">&quot;/status&quot;</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
          <span class="k">new</span> <span class="n">FkParams</span><span class="o">(</span><span class="s">&quot;f&quot;</span><span class="o">,</span> <span class="s">&quot;json&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatusJSON</span><span class="o">()),</span>
          <span class="k">new</span> <span class="n">FkParams</span><span class="o">(</span><span class="s">&quot;f&quot;</span><span class="o">,</span> <span class="s">&quot;xml&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkStatusXML</span><span class="o">())</span>
        <span class="o">)</span>
      <span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Again, I believe it’s obvious. The instance of <code>FkRegex</code> will ask an encapsulated instance of <code>TkFork</code> to return a response, and it will try to fetch it from one that <code>FkParams</code> encapsulated. If the HTTP query is <code>/status?f=xml</code>, an instance of <code>TkStatusXML</code> will be returned.</p><h2 id="http-response">HTTP Response</h2><p>Now let’s discuss the structure of the HTTP response and its object-oriented abstraction, <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Response.html"><code>Response</code></a>. This is how the interface looks:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Response</span> <span class="o">{</span>
  <span class="n">Iterable</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">head</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
  <span class="n">InputStream</span> <span class="nf">body</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">;</span>
<span class="o">}</span></code></pre></figure><p>Looks very similar to the <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html"><code>Request</code></a>, doesn’t it? Well, it’s identical, mostly because the structure of the HTTP request and response is almost identical. The only difference is the first line.</p><p>There is a collection of useful decorators that help in response building. They are <a href="/2015/02/26/composable-decorators.html">composable</a>, which makes them very convenient. For example, if you want to build a response that contains an HTML page, you compose them like this:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndex</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsWithStatus</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsWithType</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">RsWithBody</span><span class="o">(</span><span class="s">&quot;&lt;html&gt;Hello, world!&lt;/html&gt;&quot;</span><span class="o">),</span>
        <span class="s">&quot;text/html&quot;</span>
      <span class="o">),</span>
      <span class="mi">200</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>In this example, the decorator <code>RsWithBody</code> creates a response with a body but with no headers at all. Then, <code>RsWithType</code> adds the header <code>Content-Type: text/html</code> to it. Then, <code>RsWithStatus</code> makes sure the first line of the response contains <code>HTTP/1.1 200 OK</code>.</p><p>You can create your own decorators that can reuse existing ones. Take a look at how it’s done in <a href="https://github.com/yegor256/rultor/blob/1.50.2/src/main/java/com/rultor/web/RsPage.java"><code>RsPage</code></a> from rultor.com.</p><h2 id="how-about-templates">How About Templates?</h2><p>Returning simple “Hello, world” pages is not a big problem, as we can see. But what about more complex output like HTML pages, <a href="/2015/11/16/json-vs-xml.html">XML</a> documents, JSON data sets, etc? There are a few convenient <code>Response</code> decorators that enable all of that. Let’s start with <a href="http://velocity.apache.org">Velocity</a>, a simple templating engine. Well, it’s not that simple. It’s rather powerful, but I would suggest to use it in simple situations only. Here is how it works:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndex</span> <span class="kd">implements</span> <span class="n">Take</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">Response</span> <span class="nf">act</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">RsVelocity</span><span class="o">(</span><span class="s">&quot;Hello, ${name}&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Jeffrey&quot;</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>The <a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/rs/RsVelocity.html"><code>RsVelocity</code></a> constructor accepts a single argument that has to be a Velocity template. Then, you call the <code>with()</code> method, injecting data into the Velocity context. When it’s time to render the HTTP response, <code>RsVelocity</code> will “evaluate” the template against the context configured. Again, I would recommend you use this templating approach only for simple outputs.</p><p>For more complex HTML documents, I would recommend you use XML/XSLT in combination with Xembly. I explained this idea in a few previous posts: <a href="/2014/06/25/xml-and-xslt-in-browser.html">XML+XSLT in a Browser</a> and <a href="/2014/09/09/restful-web-sites.html">RESTful API and a Web Site in the Same URL</a>. It is simple and powerful—Java generates XML output and the XSLT processor transforms it into HTML documents. This is how we separate representation from data. The XSL stylesheet is a “view” and <code>TkIndex</code> is a “controller,” in terms of <a href="/2016/12/13/mvc-vs-oop.html">MVC</a>.</p><p>I’ll write a separate article about templating with Xembly and XSL very soon.</p><p>In the meantime, we’ll create decorators for <a href="http://en.wikipedia.org/wiki/Facelets">JSF/Facelets</a> and <a href="http://en.wikipedia.org/wiki/JavaServer_Pages">JSP</a> rendering in Takes. If you’re interested in helping, please fork the framework and submit your pull requests.</p><h2 id="what-about-persistence">What About Persistence?</h2><p>Now, a question that comes up is what to do with persistent entities, like databases, in-memory structures, network connections, etc. My suggestion is to initialize them inside the <code>Entry</code> class and pass them as arguments into the <code>TkApp</code> constructor. Then, the <code>TkApp</code> will pass them into the constructors of custom <em>takes</em>.</p><p>For example, we have a PostgreSQL database that contains some table data that we need to render. Here is how I would initialize a connection to it in the <code>Entry</code> class (I’m using a <a href="http://www.jolbox.com/">BoneCP</a> connection pool):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span><span class="o">...</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtCli</span><span class="o">(</span><span class="k">new</span> <span class="n">TkApp</span><span class="o">(</span><span class="n">Entry</span><span class="o">.</span><span class="na">postgres</span><span class="o">()),</span> <span class="n">args</span><span class="o">).</span><span class="na">start</span><span class="o">(</span><span class="n">Exit</span><span class="o">.</span><span class="na">NEVER</span><span class="o">);</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Source</span> <span class="nf">postgres</span><span class="o">()</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">BoneCPDataSource</span> <span class="n">src</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BoneCPDataSource</span><span class="o">();</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setDriverClass</span><span class="o">(</span><span class="s">&quot;org.postgresql.Driver&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setJdbcUrl</span><span class="o">(</span><span class="s">&quot;jdbc:postgresql://localhost/db&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setUser</span><span class="o">(</span><span class="s">&quot;root&quot;</span><span class="o">);</span>
    <span class="n">src</span><span class="o">.</span><span class="na">setPassword</span><span class="o">(</span><span class="s">&quot;super-secret-password&quot;</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">src</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Now, the constructor of <code>TkApp</code> must accept a single argument of type <code>java.sql.Source</code>:</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkApp</span> <span class="kd">extends</span> <span class="n">TkWrap</span> <span class="o">{</span>
  <span class="n">TkApp</span><span class="o">(</span><span class="kd">final</span> <span class="n">Source</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">TkApp</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="n">source</span><span class="o">));</span>
  <span class="o">}</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">Take</span> <span class="nf">make</span><span class="o">(</span><span class="kd">final</span> <span class="n">Source</span> <span class="n">source</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">TkFork</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FkRegex</span><span class="o">(</span><span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">TkIndex</span><span class="o">(</span><span class="n">source</span><span class="o">))</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Class <code>TkIndex</code> also accepts a single argument of class <code>Source</code>. I believe you know what to do with it inside <code>TkIndex</code> in order to fetch the SQL table data and convert it into HTML. The point here is that the dependency must be injected into the application (instance of class <code>TkApp</code>) at the moment of its instantiation. This is a pure and clean dependency injection mechanism, which is absolutely container-free. Read more about it in <a href="/2014/10/03/di-containers-are-evil.html">Dependency Injection Containers Are Code Polluters</a>.</p><h2 id="unit-testing">Unit Testing</h2><p>Since every class is immutable and all dependencies are injected only through constructors, unit testing is extremely easy. Let’s say we want to test <code>TkStatus</code>, which is supposed to return an HTML response (I’m using <a href="http://junit.org/">JUnit 4</a> and <a href="https://github.com/hamcrest/JavaHamcrest">Hamcrest</a>):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.MatcherAssert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.hamcrest.Matchers</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndexTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsHtmlPage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">MatcherAssert</span><span class="o">.</span><span class="na">assertThat</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">RsPrint</span><span class="o">(</span>
        <span class="k">new</span> <span class="n">TkStatus</span><span class="o">().</span><span class="na">act</span><span class="o">(</span><span class="k">new</span> <span class="n">RqFake</span><span class="o">())</span>
      <span class="o">).</span><span class="na">printBody</span><span class="o">(),</span>
      <span class="n">Matchers</span><span class="o">.</span><span class="na">equalsTo</span><span class="o">(</span><span class="s">&quot;&lt;html&gt;Hello, world!&lt;/html&gt;&quot;</span><span class="o">)</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p>Also, we can start the entire application or any individual <em>take</em> in a test HTTP server and test its behavior via a real TCP socket; for example (I’m using <a href="http://http.jcabi.com">jcabi-http</a> to make an HTTP request and check the output):</p><figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">TkIndexTest</span> <span class="o">{</span>
  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">returnsHtmlPage</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="k">new</span> <span class="n">FtRemote</span><span class="o">(</span><span class="k">new</span> <span class="n">TkIndex</span><span class="o">()).</span><span class="na">exec</span><span class="o">(</span>
      <span class="k">new</span> <span class="n">FtRemote</span><span class="o">.</span><span class="na">Script</span><span class="o">()</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exec</span><span class="o">(</span><span class="kd">final</span> <span class="n">URI</span> <span class="n">home</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
          <span class="k">new</span> <span class="n">JdkRequest</span><span class="o">(</span><span class="n">home</span><span class="o">)</span>
            <span class="o">.</span><span class="na">fetch</span><span class="o">()</span>
            <span class="o">.</span><span class="na">as</span><span class="o">(</span><span class="n">RestResponse</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertStatus</span><span class="o">(</span><span class="n">HttpURLConnection</span><span class="o">.</span><span class="na">HTTP_OK</span><span class="o">)</span>
            <span class="o">.</span><span class="na">assertBody</span><span class="o">(</span><span class="n">Matchers</span><span class="o">.</span><span class="na">containsString</span><span class="o">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="o">));</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span></code></pre></figure><p><a href="http://static.javadoc.io/org.takes/takes/1.1/org/takes/http/FtRemote.html"><code>FtRemote</code></a> starts a test web server at a random TCP port and calls the <code>exec()</code> method at the provided instance of <code>FtRemote.Script</code>. The first argument of this method is a URI of the just-started web server homepage.</p><p>The architecture of Takes framework is very modular and composable. Any individual <em>take</em> can be tested as a standalone component, absolutely independent from the framework and other <em>takes</em>.</p><h2 id="why-the-name">Why the Name?</h2><p>That’s the question I’ve been hearing rather often. The idea is simple, and it originates from the movie business. When a movie is made, the crew shoots many <em>takes</em> in order to capture the reality and put it on film. Each capture is called a <em>take</em>.</p><p>In other words, a <em>take</em> is like a snapshot of the reality.</p><p>The same applies to this framework. Each instance of <code>Take</code> represents a reality at one particular moment in time. This reality is then sent to the user in the form of a <code>Response</code>.</p><p>PS. There are a few words about authentication: <a href="/2015/05/18/cookie-based-authentication.html">How Cookie-Based Authentication Works in the Takes Framework</a>.</p><p>PPS. There are a few real web systems, which you may be interested to take a look at. They all are using Takes Framework and their code is open: <a href="https://github.com/yegor256/rultor">rultor.com</a>, <a href="/2016/03/30/jare-instant-free-cdn.html">jare.io</a>, <a href="/2016/03/15/wring-dispatcher-github-notifications.html">wring.io</a>.</p></div></article></div><div class="wrapper"> <related-posts /></div><div class="disqus" role="complementary"><p class="disqus_hint"> Please, use <a href="https://help.disqus.com/commenting/what-html-tags-are-allowed-within-comments">syntax highlighting</a> in your comments, to make them more readable.</p><div id="disqus_thread" class="disqus-thread"> <a>&nbsp;</a></div><script> var disqus_config = function () { this.page.url = document.location.href.split('?')[0].split('#')[0].replace('https://', 'http://'); this.page.identifier = this.page.url; }; (function() { var d = document, s = d.createElement('script'); s.src = '//yegor256.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript><div><p class="red"> JavaScript is disabled in your browser, that's why you can't see comments under this post.</p></div></noscript></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2019</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?9fa700503fd"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
