<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Humans should run &quot;fast&quot; tests to catch obvious mistakes, while servers should execute &quot;deep&quot; tests to ensure the highest quality." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Fast Tests Help Humans, Deep Tests Help Servers"/> <meta name="twitter:description" property="og:description" content="Humans should run &quot;fast&quot; tests to catch obvious mistakes, while servers should execute &quot;deep&quot; tests to ensure the highest quality."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2023/08/22/fast-vs-deep-testing.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?3d882d517f5"/> <link rel="apple-touch-icon" href="/favicon.ico?3d882d517f5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?3d882d517f5"/> <link rel="stylesheet" href="/css/icons.css?3d882d517f5"/> <link rel="canonical" href="https://www.yegor256.com/ru/2023/08/22/fast-vs-deep-testing.html" /> <title>Fast Tests Help Humans, Deep Tests Help Servers</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;385</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">Fast Tests Help Humans, Deep Tests Help Servers</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2023/08/22/fast-vs-deep-testing.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>Для выявления ошибок более высокой сложности автоматизированные тесты превращаются в интеграционные тесты, которые включают в себя внешние ресурсы в сценариях тестирования, вместо использования заглушек. Хотя такой подход улучшает охват тестирования, он замедляет весь процесс сборки. Это компрометирует саму идею автоматизированных тестов, которые должны служить <a href="">защитным экраном</a> и помогать программистам безопасно редактировать код. Разделение тестов на “быстрые” и “глубокие”, а затем позволение людям запускать первые, в то время как серверы запускают вторые, может быть хорошим решением проблемы.</p><p>Рассмотрите следующий Java код со простым статическим методом <code class="language-plaintext highlighter-rouge">toString()</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>static String toString(InputStream stream) throws IOException {
  final StringBuilder buf = new StringBuilder();
  while (true) {
    int d = stream.read();
    if (d == -1) {
      break;
    }
    buf.append((char) d);
  }
  return buf.toString();
}
</code></pre></div></div><p>Он считывает байты <code class="language-plaintext highlighter-rouge">stream</code> по одному, добавляет их в буфер и возвращает буфер клиенту. Вот тест JUnit5, который проверяет функциональность.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
void readsSomeData() throws IOException {
  Assertions.assertEquals(
    "ABC",
    toString(
      new ByteArrayInputStream(
        new byte[] {0x41, 0x42, 0x43}
      )
    )
  );
}
</code></pre></div></div><p>До сих пор все хорошо. Тест работает, и метод, кажется, правильный. Более того, тест выполняется очень быстро — всего 5 мс на моем ноутбуке. Однако, при более тщательном рассмотрении, мы можем обнаружить ошибку в методе: он не закрывает входной поток. Эта проблема не влияет на тест, поскольку входной поток находится в памяти и не содержит никаких ценных ресурсов, которые могут утечь. Однако, если мы введем новый тест, он выявит эту проблему:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
void readsFromManyFiles(@TempDir Path tmp) throws IOException {
  Path f = tmp.resolve("test.txt");
  Files.write(f, "Hello, world!".getBytes());
  for (int i = 0; i &lt; 20000; ++i) {
    Assertions.assertEquals(
      13,
      toString(new FileInputStream(f.toFile())).length()
    );
  }
}
</code></pre></div></div><p>Когда я запускаю этот тест, я получаю исключение <code class="language-plaintext highlighter-rouge">FileNotFoundException</code> с сообщением “Слишком много открытых файлов”. Если я уменьшу верхний предел в цикле for до 10000, ошибка исчезает. Это определенно происходит из-за максимального количества открытых файлов в Mac OS X, которое составляет 12 288. Однако на Ubuntu это ограничение установлено на 65536. Таким образом, мой тест не обнаружит ошибку, если я запущу его на Ubuntu. Я уверен, что вы знаете, как исправить эту ошибку в методе toString().</p><p>Очевидно, что второй тест гораздо медленнее первого, занимая 650 мс на моем ноутбуке (в 130 раз медленнее!). Это всего лишь пример теста, который помогает обнаружить ошибки, но требует много времени. Обычно, интеграционные тесты демонстрируют такое негативное влияние на производительность, потому что они включают использование “внешних” ресурсов, которые работают медленно. Файловая система, используемая во втором тесте, является одним из таких внешних ресурсов.</p><p>650 мс могут не вызывать проблемы, когда в молодом проекте есть всего несколько тестовых методов. Однако с увеличением числа тестов медленные тесты быстро становятся проблемой, так как общее время сборки увеличивается, что вызывает раздражение у программистов. Автоматизированные тесты, предназначенные для помощи разработчикам, превращаются в помеху. Если разработчику приходится ожидать несколько минут после каждого изменения кода, чтобы убедиться, что ничего не сломалось, возникает разочарование. Часто раздраженный разработчик может удалить эти медленные тесты.</p><p>Не нужно говорить о том, что удаление медленных тестов не является решением. Так что же является таковым? Ускорение их работы? Не совсем. Почти всегда вызывает трудности, если не невозможно, ускорение интеграционных тестов, поскольку они по своей природе медленные. Единственный способ ускорить их - замокать эти медленные внешние ресурсы. Но эти ресурсы тестируются специально для выявления ошибок, которые могут быть пропущены юнит-тестами. В нашем случае, если мы замокаем поток ввода, то второй тест пропустит ошибку. Поэтому второй (интеграционный) тест должен быть медленным, чтобы быть ценным.</p><p>Классификация тестов на <em>быстрые</em> и <em>глубокие</em> может быть решением. Первая категория включает тесты, которые максимально имитируют и выполняются не более чем за 20 мс. Вторая категория состоит из тестов, которые исследуют глубже, чтобы обнаружить скрытые ошибки, которые могут быть упущены быстрыми тестами. Как правило, модульные тесты относятся к первой категории, в то время как интеграционные тесты относятся ко второй. Различие между “модульными и интеграционными” тестами, на мой взгляд, вводит в заблуждение. “Быстрые и глубокие” тесты намного понятнее, так как очевидно, к какой категории относится тест. Если тест выполняется менее чем за 20 мс, он быстрый; если нет, то глубокий.</p><p>После того как тесты отмечены как быстрые или глубокие, их следует запускать в двух отдельных сценариях: программисты запускают быстрые тесты во время написания кода, в то время как серверы выполняют глубокие тесты во время сборки программного обеспечения и/или этапов выпуска. В JUnit5 это разделение можно достичь с помощью аннотации @Tag.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>@Test
@Tag("fast")
void readsSomeData() throws IOException {
  // ...
}
@Test
@Tag("deep")
void readsFromManyFiles(@TempDir Path tmp) throws IOException {
  // ...
}
</code></pre></div></div><p>В большинстве случаев явные ошибки будут обнаружены быстрыми тестами, что дает программистам уверенность при редактировании кода. В редких случаях, когда быстрые тесты не смогут выявить определенные ошибки, они будут обнаружены более глубокими тестами. Только после этого программисты запустят медленные тесты на своих ноутбуках.</p><p>Так можно настроить <code class="language-plaintext highlighter-rouge">pom.xml</code>, чтобы по умолчанию включить “fast” тесты:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;plugin&gt;
  &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;
  &lt;configuration&gt;
    &lt;groups&gt;fast&lt;/groups&gt;
  &lt;/configuration&gt;
&lt;/plugin&gt;
</code></pre></div></div><p>В среде CI Maven должен быть запущен со следующим флагом:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ mvn test -Dgroups=slow
</code></pre></div></div><p>Программист также может запустить «медленные» тесты на своем собственном ноутбуке с использованием того же флага командной строки. Однако это обычно делается только в том случае, если сервер выдает красный сигнал.</p><p>P.S. Кстати, у метода <code class="language-plaintext highlighter-rouge">toString()</code> есть еще одна ошибка, которая не обнаруживается ни первым, ни вторым тестом. Сможете ли вы ее определить? Можете ли вы разработать тест, который выявит эту ошибку? Как бы вы классифицировали этот тест: “быстрый” или “глубокий”?</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/30 on 2023-08-29 at 06:32</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?3d882d517f5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
