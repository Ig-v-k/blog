<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="jcabi-mysql-maven-plugin starts a fresh instance of MySQL server before integration tests and shuts it down when tests are finished." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="MySQL Maven Plugin"/> <meta name="twitter:description" property="og:description" content="jcabi-mysql-maven-plugin starts a fresh instance of MySQL server before integration tests and shuts it down when tests are finished."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2014/05/21/mysql-maven-plugin.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?d1b9aa7d6e2"/> <link rel="apple-touch-icon" href="/favicon.ico?d1b9aa7d6e2"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?d1b9aa7d6e2"/> <link rel="stylesheet" href="/css/icons.css?d1b9aa7d6e2"/> <link rel="canonical" href="https://www.yegor256.com/ru/2014/05/21/mysql-maven-plugin.html" /> <title>MySQL Maven Plugin</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;387</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">MySQL Maven Plugin</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2014/05/21/mysql-maven-plugin.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>Я использовал MySQL в нескольких веб-проектах на Java и обнаружил, что нет плагина Maven, который поможет мне протестировать мои DAO против реального сервера MySQL. Есть множество механизмов для имитации слоя сохранения данных в базе как в памяти, так и на диске. Однако всегда полезно убедиться, что ваши классы протестированы на базе данных, идентичной той, которую у вас есть в производственной среде.</p><p>Я создал свой собственный плагин Maven, <a href="http://mysql.jcabi.com">jcabi-mysql-maven-plugin</a>, который делает ровно две вещи: запускает сервер MySQL на этапе <code class="language-plaintext highlighter-rouge">pre-integration-test</code> и останавливает его на этапе <code class="language-plaintext highlighter-rouge">post-integration-test</code>.</p><p>Таким образом, вы можете настроить его в <code class="language-plaintext highlighter-rouge">pom.xml</code> (см. также полные <a href="http://mysql.jcabi.com/usage.html">инструкции по использованию</a>).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;project&gt;
  &lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
        &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;reserve-network-port&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;portNames&gt;
                &lt;portName&gt;mysql.port&lt;/portName&gt;
              &lt;/portNames&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;unpack&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;artifactItems&gt;
                &lt;artifactItem&gt;
                  &lt;groupId&gt;com.jcabi&lt;/groupId&gt;
                  &lt;artifactId&gt;mysql-dist&lt;/artifactId&gt;
                  &lt;version&gt;5.6.14&lt;/version&gt;
                  &lt;classifier&gt;${mysql.classifier}&lt;/classifier&gt;
                  &lt;type&gt;zip&lt;/type&gt;
                  &lt;overWrite&gt;false&lt;/overWrite&gt;
                  &lt;outputDirectory&gt;
                    ${project.build.directory}/mysql-dist
                  &lt;/outputDirectory&gt;
                &lt;/artifactItem&gt;
              &lt;/artifactItems&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;com.jcabi&lt;/groupId&gt;
        &lt;artifactId&gt;jcabi-mysql-maven-plugin&lt;/artifactId&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;id&gt;mysql-test&lt;/id&gt;
            &lt;goals&gt;
              &lt;goal&gt;classify&lt;/goal&gt;
              &lt;goal&gt;start&lt;/goal&gt;
              &lt;goal&gt;stop&lt;/goal&gt;
            &lt;/goals&gt;
            &lt;configuration&gt;
              &lt;port&gt;${mysql.port}&lt;/port&gt;
              &lt;data&gt;${project.build.directory}/mysql-data&lt;/data&gt;
            &lt;/configuration&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
      &lt;plugin&gt;
        &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;
        &lt;configuration&gt;
          &lt;systemPropertyVariables&gt;
            &lt;mysql.port&gt;${mysql.port}&lt;/mysql.port&gt;
          &lt;/systemPropertyVariables&gt;
        &lt;/configuration&gt;
        &lt;executions&gt;
          &lt;execution&gt;
            &lt;goals&gt;
              &lt;goal&gt;integration-test&lt;/goal&gt;
              &lt;goal&gt;verify&lt;/goal&gt;
            &lt;/goals&gt;
          &lt;/execution&gt;
        &lt;/executions&gt;
      &lt;/plugin&gt;
    &lt;/plugins&gt;
  &lt;/build&gt;
  [...]
&lt;/project&gt;
</code></pre></div></div><p>Выше настроены два плагина. Давайте посмотрим, что делает каждый из них.</p><ol> <li><p><strong><code class="language-plaintext highlighter-rouge">build-helper-maven-plugin</code></strong> резервирует временный случайный TCP-порт, который будет использоваться сервером MySQL. Мы не хотим запускать сервер на его стандартном порту 3306, так как там может уже работать другой сервер. Кроме того, если мы используем жестко закодированный TCP-порт, мы не сможем запускать несколько сборок параллельно. Это может быть не так важно, когда вы разрабатываете локально, но в среде непрерывной интеграции это может стать проблемой. Вот почему мы сначала резервируем TCP-порт.</p></li> <li><p><a href="http://maven.apache.org/plugins/maven-dependency-plugin/unpack-mojo.html"><strong><code class="language-plaintext highlighter-rouge">maven-dependency-plugin</code></strong></a> загружает дистрибутив MySQL в виде zip-архива (довольно большого файла, более 300 МБ для Linux) и распаковывает его. В этом архиве содержатся те же файлы, которые вы бы использовали для традиционной установки MySQL. После распаковки архива он готов начать обслуживать SQL-запросы как обычный сервер MySQL.</p></li> <li><p><a href="http://mysql.jcabi.com"><strong><code class="language-plaintext highlighter-rouge">jcabi-mysql-maven-plugin</code></strong></a> запускает сервер, привязывая его к случайно выбранному TCP-порту. Основной функцией моего плагина Maven является гарантирование правильного запуска сервера MySQL на каждой платформе (Mac OS, Linux, Windows) и его остановка, когда он больше не нужен. Все остальное делается самим распространением MySQL.</p></li> <li><p><strong><code class="language-plaintext highlighter-rouge">maven-failsafe-plugin</code></strong> запускает модульные тесты на этапе <code class="language-plaintext highlighter-rouge">integration-test</code>. Его основное отличие от <code class="language-plaintext highlighter-rouge">maven-surefire-plugin</code> заключается в том, что он не прерывает сборку, когда некоторые тесты завершаются неудачно. Вместо этого он сохраняет все ошибки в дополнительных файлах в директории <code class="language-plaintext highlighter-rouge">target</code> и позволяет продолжить сборку. Позже, когда мы вызываем его цель <code class="language-plaintext highlighter-rouge">verify</code>, он прерывает сборку, если во время выполнения его цели <code class="language-plaintext highlighter-rouge">integration-test</code> возникли какие-либо ошибки.</p></li> </ol><p>Чтобы быть точным, это порядок, в котором Maven будет выполнять настроенные цели:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jcabi-mysql-maven-plugin:classify
maven-dependency-plugin:unpack
build-helper-maven-plugin:reserve-network-port
jcabi-mysql-maven-plugin:start
maven-failsafe-plugin:integration-test
jcabi-mysql-maven-plugin:stop
maven-failsafe-plugin:verify
</code></pre></div></div><p>Запустите <code class="language-plaintext highlighter-rouge">mvn clean install</code> и посмотрите, как это работает. Если по какой-то причине не работает, не стесняйтесь <a href="https://github.com/jcabi/jcabi-mysql-maven-plugin/issues">сообщить о проблеме на GitHub</a>.</p><p>Теперь пришло время создать интеграционный тест, который будет подключаться к временному серверу MySQL, создавать там таблицу и вставлять в нее некоторые данные. Это всего лишь пример, чтобы показать, что сервер MySQL работает и способен обрабатывать транзакции (я использую <a href="http://jdbc.jcabi.com">jcabi-jdbc</a>).</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public class FooITCase {
  private static final String PORT = System.getProperty("mysql.port");
  @Test
  public void worksWithMysqlServer() {
    Connection conn = DriverManager.getConnection(
      String.format(
        "jdbc:mysql://localhost:%s/root?user=root&amp;password=root",
        FooITCase.PORT
      )
    );
    new JdbcSession(conn)
      .sql("CREATE TABLE foo (id INT PRIMARY KEY)")
      .execute();
  }
}
</code></pre></div></div><p>Если вы используете Hibernate, просто создайте файл <code class="language-plaintext highlighter-rouge">db.properties</code> в каталоге <code class="language-plaintext highlighter-rouge">src/test/resources</code>. В этом файле вы можете сделать что-то вроде:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hibernate.connection.url=jdbc:mysql://localhost:${mysql.port}/root
hibernate.connection.username=root
hibernate.connection.password=root
</code></pre></div></div><p>Мавен заменит <code class="language-plaintext highlighter-rouge">${mysql.port}</code> на номер зарезервированного TCP-порта во время копирования ресурсов. Эта операция называется “фильтрация ресурсов”, и вы можете прочитать о ней <a href="http://maven.apache.org/plugins/maven-resources-plugin/examples/filter.html">здесь</a>.</p><p>Вот и все. Я использую <a href="http://mysql.jcabi.com">jcabi-mysql-maven-plugin</a> в нескольких проектах, и он помогает мне быть уверенным в том, что мой код работает с настоящим сервером MySQL. Я также использую <a href="http://www.liquibase.org/documentation/maven/">плагин</a> <a href="http://www.liquibase.org/">Liquibase</a> для Maven, чтобы заполнить пустой сервер таблицами, необходимыми для приложения. Тем не менее, это будет рассказано в следующей статье.</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/35 on 2023-09-09 at 16:31</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?d1b9aa7d6e2"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
