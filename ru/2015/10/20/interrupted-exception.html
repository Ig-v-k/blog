<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Checked InterruptedException in Java is a constant source of pain for many of us; here is my understanding of how it should be handled." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="What Do You Do With InterruptedException?"/> <meta name="twitter:description" property="og:description" content="Checked InterruptedException in Java is a constant source of pain for many of us; here is my understanding of how it should be handled."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2015/10/20/interrupted-exception.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?83af7328a7a"/> <link rel="apple-touch-icon" href="/favicon.ico?83af7328a7a"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?83af7328a7a"/> <link rel="stylesheet" href="/css/icons.css?83af7328a7a"/> <link rel="canonical" href="https://www.yegor256.com/ru/2015/10/20/interrupted-exception.html" /> <title>What Do You Do With InterruptedException?</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;385</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">What Do You Do With InterruptedException?</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2015/10/20/interrupted-exception.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p><a href="http://docs.oracle.com/javase/7/docs/api/java/lang/InterruptedException.html"><code class="language-plaintext highlighter-rouge">InterruptedException</code></a> is a permanent source of pain in Java, for junior developers especially. But it shouldn’t be. It’s a rather simple and easy-to-understand idea. Let me try to describe and simplify it.</p><p>Давайте начнем с этого кода:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>while (true) {
  // Nothing
}
</code></pre></div></div><p>Что он делает? Ничего, он просто бесконечно крутит процессор. Можем ли мы прекратить его? Нет, в Java. Он остановится только тогда, когда полностью остановится вся JVM, когда вы нажмете <code class="language-plaintext highlighter-rouge">Ctrl-C</code>. В Java нет способа прекратить поток, если только поток не завершится сам по себе. Это принцип, о котором мы должны помнить, и все остальное будет очевидным.</p><p>Давайте поместим эту бесконечную петлю в поток:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread loop = new Thread(
  new Runnable() {
    @Override
    public void run() {
      while (true) {
      }
    }
  }
);
loop.start();
// Now how do we stop it?
</code></pre></div></div><p>Итак, как остановить поток, когда нам это необходимо?</p><p>Вот как это создано на Java. В каждом потоке есть флаг, который мы можем установить извне. И поток может проверять его время от времени и остановить свое выполнение. Добровольно! Вот как:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Thread loop = new Thread(
  new Runnable() {
    @Override
    public void run() {
      while (true) {
        if (Thread.interrupted()) {
          break;
        }
        // Continue to do nothing
      }
    }
  }
);
loop.start();
loop.interrupt();
</code></pre></div></div><p>Это единственный способ попросить поток остановиться. В этом примере используются два метода. Когда я вызываю <code class="language-plaintext highlighter-rouge">loop.interrupt()</code>, флаг устанавливается в <code class="language-plaintext highlighter-rouge">true</code> где-то внутри потока <code class="language-plaintext highlighter-rouge">loop</code>. Когда я вызываю <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#interrupted%28%29"><code class="language-plaintext highlighter-rouge">interrupted()</code></a>, флаг возвращается и сразу же устанавливается в <code class="language-plaintext highlighter-rouge">false</code>. Да, это дизайн метода. Он проверяет флаг, возвращает его и устанавливает в <code class="language-plaintext highlighter-rouge">false</code>. Это некрасиво, я знаю.</p><p>Таким образом, если я никогда не вызываю <code class="language-plaintext highlighter-rouge">Thread.interrupted()</code> внутри потока и не завершаю его, когда флаг установлен в <code class="language-plaintext highlighter-rouge">true</code>, никто не сможет остановить меня. Буквально, я буду игнорировать их вызовы к <code class="language-plaintext highlighter-rouge">interrupt()</code>. Они будут просить меня остановиться, но я буду их игнорировать. Они не смогут прервать меня.</p><p>Таким образом, чтобы подвести итог тому, что мы узнали до сих пор, правильно спроектированный поток будет время от времени проверять этот флаг и останавливаться корректно. Если код не проверяет флаг и никогда не вызывает <code class="language-plaintext highlighter-rouge">Thread.interrupted()</code>, то он принимает факт того, что рано или поздно он будет принудительно завершен, нажав <code class="language-plaintext highlighter-rouge">Ctrl-C</code>.</p><p>Звучит логично на данный момент? Надеюсь, что да.</p><p>Теперь в JDK есть несколько методов, которые проверяют флаг за нас и выбрасывают <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/InterruptedException.html"><code class="language-plaintext highlighter-rouge">InterruptedException</code></a>, если он установлен. Например, так работает метод <a href="http://docs.oracle.com/javase/7/docs/api/java/lang/Thread.html#sleep%28long%29"><code class="language-plaintext highlighter-rouge">Thread.sleep()</code></a> (используя очень примитивный подход):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void sleep(long millis)
  throws InterruptedException {
  while (/* You still need to wait */) {
    if (Thread.interrupted()) {
      throw new InterruptedException();
    }
    // Keep waiting
  }
}
</code></pre></div></div><p>Почему это делается таким образом? Почему он не может просто ждать и никогда не проверять флаг? Я верю, что это делается по хорошей причине. И причина в следующем (исправьте меня, если я не прав): Код должен быть либо максимально быстрым, либо готовым к прерыванию, ничего между этим.</p><p>Если ваш код работает быстро, вы никогда не проверяете флаг прерывания, потому что не хотите иметь дело с какими-либо прерываниями. Если ваш код медленный и может занимать несколько секунд для выполнения, сделайте это явным образом и обработайте прерывания каким-либо способом.</p><p>Вот почему <code class="language-plaintext highlighter-rouge">InterruptedException</code> является <a href="">проверяемым</a> исключением. Его конструкция говорит вам, что если вы хотите приостановить выполнение на несколько миллисекунд, сделайте ваш код готовым к прерыванию. Вот как это выглядит на практике:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>try {
  Thread.sleep(100);
} catch (InterruptedException ex) {
  // Stop immediately and go home
}
</code></pre></div></div><p>Хорошо, вы можете позволить ему подняться на более высокий уровень, где они будут ответственны за его перехват. Суть в том, что кто-то должен будет перехватить его и сделать что-то с этой нитью. В идеале, просто остановить ее, так как в этом и состоит смысл флага. Если возникает исключение <code class="language-plaintext highlighter-rouge">InterruptedException</code>, это означает, что кто-то проверил флаг, и нашей нити нужно как можно скорее завершить то, что она делает.</p><p>Владелец ветки больше не хочет ждать. И мы должны уважать решение нашего владельца.</p><p>Стало быть, когда вы поймали <code class="language-plaintext highlighter-rouge">InterruptedException</code>, вам придется сделать все возможное, чтобы завершить то, что вы делаете, и выйти.</p><p>Теперь еще раз взгляните на код <code class="language-plaintext highlighter-rouge">Thread.sleep()</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public static void sleep(long millis)
  throws InterruptedException {
  while (/* ... */) {
    if (Thread.interrupted()) {
      throw new InterruptedException();
    }
  }
}
</code></pre></div></div><p>Помните, что <code class="language-plaintext highlighter-rouge">Thread.interrupted()</code> не только возвращает флаг, но и сбрасывает его в значение <code class="language-plaintext highlighter-rouge">false</code>. Таким образом, после выбрасывания <code class="language-plaintext highlighter-rouge">InterruptedException</code>, флаг сбрасывается. Поток больше не знает ничего о запросе на прерывание, отправленном владельцем.</p><p>Владелец потока попросил нас остановиться, <code class="language-plaintext highlighter-rouge">Thread.sleep()</code> обнаружил этот запрос, удалил его и вызвал <code class="language-plaintext highlighter-rouge">InterruptedException</code>. Если вы снова вызовете <code class="language-plaintext highlighter-rouge">Thread.sleep()</code>, он не будет знать ничего о прерывании и ничего не вызовет.</p><p>Понимаете, на что я намекаю? Очень важно не потерять это <code class="language-plaintext highlighter-rouge">InterruptedException</code>. Мы не можем просто поглотить его и продолжить. Это будет серьезным нарушением всей идеи многопоточности в Java. Наш владелец (владелец нашего потока) просит нас остановиться, а мы просто игнорируем это. Это очень плохая идея.</p><p>Это то, что большинство из нас делает с <code class="language-plaintext highlighter-rouge">InterruptedException</code>:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>try {
  Thread.sleep(100);
} catch (InterruptedException ex) {
  throw new RuntimeException(ex);
}
</code></pre></div></div><p>Кажется, что это логично, но это не гарантирует, что более высокий уровень действительно остановит все и выйдет. Они могут просто перехватить исключение во время выполнения, и поток останется активным. Владелец потока будет разочарован.</p><p>Мы должны сообщить вышестоящему уровню, что мы только что получили запрос на прерывание. Мы не можем просто бросить исключение времени выполнения. Такое поведение было бы слишком неответственным. Вся нить получила запрос на прерывание, и мы просто поглощаем его и преобразуем в <code class="language-plaintext highlighter-rouge">RuntimeException</code>. Мы не можем так легкомысленно относиться к такой серьезной ситуации.</p><p>Вот что нам нужно сделать:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>try {
  Thread.sleep(100);
} catch (InterruptedException ex) {
  Thread.currentThread().interrupt(); // Here!
  throw new RuntimeException(ex);
}
</code></pre></div></div><p>Мы устанавливаем флаг обратно на <code class="language-plaintext highlighter-rouge">true</code>!</p><p>Теперь никто не будет обвинять нас в безответственном отношении к ценному флагу. Мы нашли его в состоянии <code class="language-plaintext highlighter-rouge">true</code>, очистили его, установили обратно в <code class="language-plaintext highlighter-rouge">true</code> и вызвали исключение времени выполнения. Что произойдет дальше, нас не волнует.</p><p>Думаю, это всё. Более подробное и официальное описание этой проблемы можно найти здесь: <a href="http://www.ibm.com/developerworks/library/j-jtp05236/">Java Theory and Practice: Dealing With <code class="language-plaintext highlighter-rouge">InterruptedException</code></a>.</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/002 on 2023-08-23 at 20:05</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?83af7328a7a"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
