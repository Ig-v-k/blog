<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Cookie-based authentication is a simple and powerful mechanism to enable website user login in a RESTful and lightweight way; the Takes framework does it with a few composable decorators." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="How Cookie-Based Authentication Works in the Takes Framework"/> <meta name="twitter:description" property="og:description" content="Cookie-based authentication is a simple and powerful mechanism to enable website user login in a RESTful and lightweight way; the Takes framework does it with a few composable decorators."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2015/05/18/cookie-based-authentication.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?3d882d517f5"/> <link rel="apple-touch-icon" href="/favicon.ico?3d882d517f5"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?3d882d517f5"/> <link rel="stylesheet" href="/css/icons.css?3d882d517f5"/> <link rel="canonical" href="https://www.yegor256.com/ru/2015/05/18/cookie-based-authentication.html" /> <title>How Cookie-Based Authentication Works in the Takes Framework</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;385</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">How Cookie-Based Authentication Works in the Takes Framework</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2015/05/18/cookie-based-authentication.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>Когда вы вводите свой адрес электронной почты и пароль на странице входа в Facebook, вы попадаете в свою учетную запись. Затем, где бы вы ни находились на сайте, вы всегда видите свою фотографию в правом верхнем углу страницы. Facebook помнит вас и не просит пароль снова и снова. Это работает благодаря <a href="https://en.wikipedia.org/wiki/HTTP_cookie">HTTP-кукам</a> и называется <em>аутентификацией на основе куков</em>. Несмотря на то, что этот механизм часто вызывает определенные проблемы безопасности, он очень популярен и прост. Вот как <a href="http://www.takes.org">Takes</a> делает это возможным всего за несколько строк кода.</p><p>Сначала давайте посмотрим, как это работает. Кроме того, давайте посмотрим, как я считаю, что это должно работать.</p><p>Шаг первый: Пользователь вводит электронную почту и пароль, а затем нажимает “Отправить”. Сервер получает POST-запрос с этой информацией внутри:</p><div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST / HTTP/1.1
Host: www.facebook.com
Content-Type: application/x-www-form-urlencoded

email=me@yegor256.com&amp;password=itisasecret ```

Сервер сравнивает предоставленную информацию с записями и принимает решение о дальнейших действиях. Если информация недействительна, сервер возвращает ту же страницу входа, просит вас ввести ее снова. Если информация действительна, сервер возвращает что-то вроде этого:

</code></pre></div></div><p>HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Поскольку код состояния ответа равен 303, браузер переходит на страницу, указанную в заголовке `Location`, и открывает главную страницу сайта. Вот что он отправляет на сервер:

</code></pre></div></div><p>GET / HTTP/1.1 Host: www.facebook.com Cookie: user=me@yegor256.com</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Сервер получает мою электронную почту из заголовка `Cookie` и понимает, что это снова я! Не нужно спрашивать пароль снова. Сервер доверяет информации из куки. Вот и всё. В этом и заключается аутентификация на основе cookie.

## Wait ... What About Security?

Правильно, а что насчет безопасности? Если сервер доверяет любому запросу браузера с электронной почтой пользователя в заголовке "Cookie", то любой смог бы отправить мою электронную почту из другого места и получить доступ к моей учетной записи.

Первый шаг для предотвращения этого - зашифровать электронную почту с помощью секретного ключа шифрования, известного только серверу. Никто, кроме самого сервера, не сможет зашифровать его так же, как сервер должен расшифровать его. Ответ будет выглядеть так, используя пример шифрования с помощью [XOR-шифра](https://en.wikipedia.org/wiki/XOR_cipher) с ключом `bamboo`.

</code></pre></div></div><p>HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=b1ccafd92c568515100f5c4d104671003cfa39</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Это не самый лучший механизм шифрования, однако для надежного шифрования лучше использовать что-то более надежное, например [DES](https://en.wikipedia.org/wiki/Data_Encryption_Standard).

Всё это звучит хорошо, но что, если кто-то перехватит трафик между сервером и браузером и получит зашифрованный email-файл cookie? В этом случае вор сможет использовать тот же самый cookie для аутентификации, даже не зная его содержимого. Сервер доверит информации и позволит человеку войти в мой аккаунт. Этот тип атаки называется [атакой "человек посередине"](http://en.wikipedia.org/wiki/Man-in-the-middle_attack) (MITM). Чтобы предотвратить это, мы должны использовать HTTPS и сообщить браузеру, что cookie является конфиденциальным и не должно возвращаться на сервер без SSL-шифрования. Это делается с помощью дополнительного флага в заголовке `Set-Cookie`.

</code></pre></div></div><p>HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com; Secure</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Существует еще один тип атаки, связанный с аутентификацией на основе куки, основанный на возможности браузера выставлять все куки, связанные с веб-страницей, для выполнения внутри нее JavaScript. Злоумышленник может внедрить злонамеренный код JavaScript на страницу (Не спрашивайте меня как ... это произойдет только если весь HTML рендеринг выполняется неправильно), и этот код получит доступ к куке. Затем код отправит куку куда-то еще, чтобы злоумышленник мог ее собрать. Этот тип атаки называется [межсайтовый скриптинг](http://en.wikipedia.org/wiki/Cross-site_scripting) (XSS). Чтобы предотвратить это, существует еще один флаг для заголовка `Set-Cookie`, называемый `HttpOnly`:

</code></pre></div></div><p>HTTP/1.1 303 See Other Location: www.facebook.com Set-Cookie: user=me@yegor256.com; Secure; HttpOnly</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Наличие этого флага сообщит браузеру, что эту конкретную куку можно передавать обратно на сервер только через HTTP-запросы. JavaScript не будет иметь к ней доступа.

## How It's Done in Takes

Вот как механизм аутентификации на основе куки реализован в фреймворке [Takes](http://www.takes.org). Весь фреймворк состоит из *takes*, которые получают запросы и генерируют ответы ([эта статья]() подробно объясняет фреймворк). Когда приходит запрос, нам нужно найти аутентификационную куку в заголовке `Cookie` и преобразовать ее в учетные данные пользователя. Когда ответ отправляется, мы должны добавить к нему заголовок `Set-Cookie` с зашифрованными учетными данными пользователя. Вот и все. Всего лишь два шага.

Предположим, у нас есть страница аккаунта, которая должна показывать текущий баланс пользователя.

</code></pre></div></div><p>final class TkAccount implements Take { private final Balances balances; @Override public Response act(final Request request) { final Identity user = // get it from request return RsHTML( String.format( “&lt;html&gt;Your balance is %s&lt;/html&gt;”, this.balances.retrieve(user) ) ); } }</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Сразу после получения `request`, мы должны извлечь идентификацию пользователя, закодированную в аутентификационном cookie. Чтобы сделать этот механизм повторно используемым, у нас есть декоратор [`TkAuth`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/TkAuth.html), который оборачивает существующий *take*, декодирует входящий cookie и добавляет новый заголовок `TkAuth` к запросу с информацией об идентификации пользователя.

</code></pre></div></div><p>final Codec codec = new CcHex(new CcXOR(new CcPlain())); final Pass pass = new PsCookie(codec); new TkAuth(new TkAccount(), pass);</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Опять же, когда `TkAuth` получает запрос с аутентификационным файлом cookie внутри, он запрашивает у `pass` расшифровать файл cookie и вернуть либо допустимый [`Identity`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Identity.html), либо `Identity.ANONYMOUS`.

Затем, когда ответ возвращается обратно в браузер, `TkAuth` запрашивает от `pass` кодирование идентификатора обратно в строку и добавляет `Set-Cookie` в ответ.

[`PsCookie`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsCookie.html) использует экземпляр [`Codec`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/codecs/Codec.html) для выполнения этих операций обратного и прямого кодирования.

Когда наш `TkAccount` *take* хочет получить текущую аутентифицированную учетную запись пользователя из запроса, он может использовать [`RqAuth`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/RqAuth.html), вспомогательный декоратор [`Request`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/Request.html).

</code></pre></div></div><p>final class TkAccount implements Take { @Override public Response act(final Request request) { final Identity user = new RqAuth(request).identity(); // other manipulations with the user } }</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Декоратор `RqAuth` использует заголовок, добавленный `PsCookie`, для аутентификации пользователя и создания объекта `Identity`.

## How Is It Composable?

Этот механизм действительно очень расширяемый и "компонуемый". Допустим, мы хотим пропустить аутентификацию во время интеграционного тестирования. Вот как:

</code></pre></div></div><p>new TkAuth( take, // original application “take” new PsChain( new PsFake(/* if running integration tests */), new PsCookie( new CcHex(new CcXOR(new CcPlain())) ) ) );</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
[`PsChain`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsChain.html) реализует [`Pass`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/Pass.html) и пытается аутентифицировать пользователя, запрашивая все инкапсулированные пароли поочередно. Первый в цепочке - [`PsFake`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsFake.html). Используя единственный булевый аргумент в своем конструкторе, он принимает решение, вернуть фальшивую личность или ничего не вернуть. С помощью единственного булевого триггера мы можем отключить весь механизм аутентификации в приложении.

Допустим, вы хотите аутентифицировать пользователей через Facebook OAuth. Вот как:

</code></pre></div></div><p>new TkAuth( take, // original application “take” new PsChain( new PsByFlag( new PsByFlag.Pair( PsFacebook.class.getSimpleName(), new PsFacebook( “… Facebook API key …”, “… Facebook API secret …” ) ) ), new PsCookie( new CcHex(new CcXOR(new CcPlain())) ) ) );</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
Когда пользователь нажимает на ссылку входа на вашем сайте, браузер переходит на `facebook.com`, где проверяется его или ее личность. Затем Facebook возвращает ответ на перенаправление `302` с заголовком `Location`, установленным на URL, который мы предоставляем в ссылке для входа. Ссылка должна содержать что-то вроде этого: `?PsByFlag=PsFacebook`. Это сообщит [`PsByFlag`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/PsByFlag.html) о том, что этот запрос аутентифицирует пользователя.

`PsByFlag` will iterate through all encapsulated "pairs" and try to find the right one. [`PsFacebook`](http://static.javadoc.io/org.takes/takes/1.1/org/takes/facets/auth/social/PsFacebook.html) will be the first and the right one. It will connect to the Facebook API using the provided credentials and will retrieve all possible information about the user.

Вот как мы можем реализовать механизм выхода из системы:

</code></pre></div></div><p>new TkAuth( take, // original application “take” new PsChain( new PsByFlag( new PsByFlag.Pair( PsFacebook.class.getSimpleName(), new PsFacebook( “… Facebook API key …”, “… Facebook API secret …” ) ), new PsByFlag.Pair( PsLogout.class.getSimpleName(), new PsLogout() ) ), new PsCookie( new CcHex(new CcXOR(new CcPlain())) ) ) ); ```</p><p>Теперь мы можем добавить <code class="language-plaintext highlighter-rouge">?PsByFlag=PsLogout</code> к любой ссылке на сайте, и это приведет к выходу текущего пользователя.</p><p>Вы можете увидеть, как все это работает в реальном приложении, изучив класс <a href="https://github.com/yegor256/rultor/blob/master/src/main/java/com/rultor/web/TkAppAuth.java"><code class="language-plaintext highlighter-rouge">TkAppAuth</code></a> в <a href="https://www.rultor.com">Rultor</a>.</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/30 on 2023-08-29 at 06:06</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?3d882d517f5"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
