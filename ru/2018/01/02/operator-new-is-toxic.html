<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Instantiating objects via operator NEW is what we have to do in order to have those objects; however, it's important where this happens." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Operator new() is Toxic"/> <meta name="twitter:description" property="og:description" content="Instantiating objects via operator NEW is what we have to do in order to have those objects; however, it's important where this happens."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/ru/2018/01/02/operator-new-is-toxic.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?278749a84ec"/> <link rel="apple-touch-icon" href="/favicon.ico?278749a84ec"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?278749a84ec"/> <link rel="stylesheet" href="/css/icons.css?278749a84ec"/> <link rel="canonical" href="https://www.yegor256.com/ru/2018/01/02/operator-new-is-toxic.html" /> <title>Operator new() is Toxic</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;387</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/research.html" title="My research directions and progress">Research</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">Operator new() is Toxic</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2018/01/02/operator-new-is-toxic.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>Для создания экземпляров объектов в большинстве объектно-ориентированных языков программирования, таких как Java, Ruby и C++, мы используем оператор <code class="language-plaintext highlighter-rouge">new()</code>. Хорошо, если мы не используем статические фабричные методы, которые мы не используем, потому что они зловредны. Несмотря на то, что создание нового объекта в любой момент кажется таким простым, я бы рекомендовал быть более осторожным с этим довольно токсичным оператором.</p><p>Я уверен, вы понимаете, что проблема с этим оператором заключается в том, что он связывает объекты, делая тестирование и повторное использование очень сложными или даже невозможными. Допустим, есть история в файле, которую нам нужно прочитать в виде UTF-8 текста (я использую <a href="http://static.javadoc.io/org.cactoos/cactoos/0.25.6/org/cactoos/text/TextOf.html"><code class="language-plaintext highlighter-rouge">TextOf</code></a> из <a href="http://www.cactoos.org">Cactoos</a>):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Story {
  String text() {
    return new TextOf(
      new File("/tmp/story.txt")
    ).asString();
  }
}
</code></pre></div></div><p>Кажется, что это очень просто, но проблема очевидна: класс <code class="language-plaintext highlighter-rouge">Story</code> нельзя использовать повторно. Он может только читать один конкретный файл. Более того, тестирование его будет довольно сложным, так как он читает содержимое именно из одного места, которое нельзя изменить вообще. Формально эта проблема известна как <em>неразрывная зависимость</em> - мы не можем разорвать связь между <code class="language-plaintext highlighter-rouge">Story</code> и <code class="language-plaintext highlighter-rouge">/tmp/story.txt</code> - они навсегда вместе.</p><p>Для решения этой проблемы нам необходимо ввести конструктор и позволить <code class="language-plaintext highlighter-rouge">Story</code> принимать местоположение контента в качестве аргумента.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Story {
  private final File file;
  Story(File f) {
    this.file = f;
  }
  String text() {
    return new TextOf(this.file).asString();
  }
}
</code></pre></div></div><p>Теперь каждому пользователю <code class="language-plaintext highlighter-rouge">Story</code> нужно знать имя файла:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new Story(new File("/tmp/story.txt"));
</code></pre></div></div><p>Это не очень удобно, особенно для тех пользователей, которые раньше использовали <code class="language-plaintext highlighter-rouge">Story</code> и ничего не знают о пути к файлу. Чтобы помочь им, мы вводим вторичный конструктор:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Story {
  private final File file;
  Story() { // Here!
    this(new File("/tmp/story.txt"));
  }
  Story(File f) {
    this.file = f;
  }
  String text() {
    return new TextOf(this.file).asString();
  }
}
</code></pre></div></div><p>Теперь мы просто создаем экземпляр через конструктор без аргументов, так же, как мы делали раньше.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new Story();
</code></pre></div></div><p>Я уверен, что вы отлично знакомы с этой техникой, которая также известна как <a href="http://martinfowler.com/articles/injection.html">внедрение зависимостей</a>. Фактически, я не говорю ничего нового. На что я хочу, чтобы вы обратили внимание здесь - это местоположение и количество операторов <code class="language-plaintext highlighter-rouge">new</code> во всех трех фрагментах кода.</p><p>В первом фрагменте оба оператора <code class="language-plaintext highlighter-rouge">new</code> находятся в методе <code class="language-plaintext highlighter-rouge">text()</code>. Во втором фрагменте мы потеряли один из них. В третьем фрагменте один оператор находится в методе, в то время как второй переместился в конструктор.</p><p>Помните об этом факте и продолжим.</p><p>Что, если файл не в кодировке UTF-8, а в <a href="https://en.wikipedia.org/wiki/KOI8-R">KOI8-R</a>? Класс <code class="language-plaintext highlighter-rouge">TextOf</code>, а затем метод <code class="language-plaintext highlighter-rouge">Story.text()</code>, вызовут исключение. Однако класс <code class="language-plaintext highlighter-rouge">TextOf</code> способен читать в любой кодировке, ему просто необходимо иметь дополнительный аргумент для своего конструктора:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>new TextOf(this.file, "KOI8_R").asString();
</code></pre></div></div><p>Для того чтобы сделать <code class="language-plaintext highlighter-rouge">Story</code> способным использовать различные кодировки, нам нужно ввести несколько дополнительных вторичных конструкторов и изменить его основной конструктор.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class Story {
  private final Text text;
  Story() {
    this(new File("/tmp/story.txt"));
  }
  Story(File f) {
    this(f, StandardEncodings.UTF_8);
  }
  Story(File f, Encoding e) {
    this(new TextOf(f, e));
  }
  Story(Text t) {
    this.text = t;
  }
  String text() {
    return this.text.asString();
  }
}
</code></pre></div></div><p>Это всего лишь инъекция зависимостей, но обратите внимание на расположение оператора <code class="language-plaintext highlighter-rouge">new</code>. Теперь все они находятся в конструкторах, и ни одного не осталось в методе <code class="language-plaintext highlighter-rouge">text()</code>.</p><p>Тенденция здесь очевидна для меня: чем больше операторы <code class="language-plaintext highlighter-rouge">new</code> остаются в методах, тем менее переиспользуемым и тестируемым является класс.</p><p>Другими словами, оператор <code class="language-plaintext highlighter-rouge">new</code> - вещь довольно токсичная, поэтому старайтесь использовать его минимально в ваших методах. Обязательно создавайте экземпляры всего или почти всего ваших объектов во вторичных конструкторах.</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/35 on 2023-09-15 at 15:25</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?278749a84ec"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
