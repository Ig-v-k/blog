<!DOCTYPE html> <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US" xml:lang="en-US" itemscope="" itemtype="http://schema.org/WebSite"> <head> <meta charset="utf-8"/> <meta name="description" content="Do you test your Ruby classes for thread safety? If you do, you may find this new Ruby gem useful. It helps you start multiple threads, run the code inside, and validate the output." /> <meta name="keywords" content="" /> <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1"/> <meta name="google-site-verification" content="JEj_gQr2CPe2QKGw8XdMz0R7VboQIUbX3FlM-lwTq-8" /> <meta name="author" content="Yegor Bugayenko"> <meta name="og:site_name" content="Yegor Bugayenko"/> <meta name="og:type" content="article" /> <meta name="og:locale" content="en_US" /> <meta name="twitter:account_id" content="4503599630178231" /> <meta name="twitter:creator" content="@yegor256"/> <meta name="twitter:site" content="@yegor256"/> <meta name="twitter:title" property="og:title" content="Do You Test Ruby Code for Thread Safety?"/> <meta name="twitter:description" property="og:description" content="Do you test your Ruby classes for thread safety? If you do, you may find this new Ruby gem useful. It helps you start multiple threads, run the code inside, and validate the output."/> <meta name="twitter:url" property="og:url" content="https://www.yegor256.com/zh/2018/11/06/ruby-threads.html"/> <meta name="telegram:channel" content="AAAAAEJFMRzsRTRxM3ec6A"/> <link rel="search" type="application/opensearchdescription+xml" href="/opensearch.xml" title="yegor256" /> <link rel="shortcut icon" href="/favicon.ico?f8c5f5e211e"/> <link rel="apple-touch-icon" href="/favicon.ico?f8c5f5e211e"/> <link rel="alternate" type="application/rss+xml" title="RSS for yegor256.com" href="https://www.yegor256.com/rss.xml"/> <link rel="stylesheet" href="/css/layout.css?f8c5f5e211e"/> <link rel="stylesheet" href="/css/icons.css?f8c5f5e211e"/> <link rel="canonical" href="https://www.yegor256.com/zh/2018/11/06/ruby-threads.html" /> <title>Do You Test Ruby Code for Thread Safety?</title> </head> <body><div class="wrapper"> <aside class="header-toggle unprintable" id="header-toggle" title="Show the menu" onclick="$('#header').show();$('#header-toggle').hide();">&#9776;</aside> <header class="header" id="header"><div class="face"> <a href="/about-me.html#form" class="sub" title="Click to subscribe to my monthly newsletter"><span>Subscribe</span></a> <a href="/about-me.html" style="position:relative;"> <img src="/images/face-256x256.jpg" class="photo" alt="Yegor Bugayenko"/> </a></div><nav><ul class="menu social notranslate"> <li><a href="https://twitter.com/intent/follow?screen_name=yegor256" rel="nofollow" title="Follow me on Twitter"><i class="icon icon-twitter notranslate" aria-hidden="true"></i></a></li> <li><a href="/rss.xml" rel="nofollow" title="Subscribe to my RSS feed"><i class="icon icon-rss notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://github.com/yegor256" rel="nofollow" title="My GitHub profile"><i class="icon icon-github notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="http://stackoverflow.com/users/187141/yegor256" rel="nofollow" title="My Stack Overflow profile"><i class="icon icon-stackoverflow notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.facebook.com/yegor256" rel="nofollow" title="Follow me on Facebook"><i class="icon icon-facebook notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://instagram.com/yegor256" rel="nofollow" title="Follow me on Instagram"><i class="icon icon-instagram notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.linkedin.com/in/yegor256" rel="nofollow" title="My LinkedIn profile"><i class="icon icon-linkedin notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.youtube.com/c/yegor256?sub_confirmation=1" rel="nofollow" title="My Youtube video channel"><i class="icon icon-youtube notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://www.pinterest.com/yegor256/" rel="nofollow" title="My Pinterest boards"><i class="icon icon-pinterest notranslate" aria-hidden="true"></i></a></li> <li><a itemprop="sameAs" href="https://angel.co/yegor256" rel="nofollow" title="My AngelList profile"><i class="icon icon-angellist notranslate" aria-hidden="true"></i></a></li> <li><a href="https://soundcloud.com/yegor256" rel="nofollow" title="My podcast"><i class="icon icon-podcast notranslate" aria-hidden="true"></i></a></li> <li><a href="https://itunes.apple.com/us/podcast/yegor256-podcast/id1150826721" rel="nofollow" title="My iTunes podcast"><i class="icon icon-itunes notranslate" aria-hidden="true"></i></a></li> <li><a href="https://t.me/yegor256news" rel="nofollow" title="My Telegram public channel"><i class="icon icon-telegram notranslate" aria-hidden="true"></i></a></li> <li><a href="mailto:blog@yegor256.com" rel="nofollow" title="Email me any time"><i class="icon icon-mail notranslate" aria-hidden="true"></i></a></li></ul><ul class="menu"> <li><a href="/" title="Home page">Home</a></li> <li ><a href="/best.html" title="Best articles to read">12&#160;Best</a></li> <li ><a href="/contents.html" title="The contents of the entire blog">All&#160;387</a></li> <li ><a href="/teaching.html" title="My courses and lectures">Teaching</a></li> <li ><a href="/talks.html" title="Future and past conference talks">Talks</a></li> <li ><a href="/books.html" title="The books I wrote">Books</a></li> <li ><a href="/papers.html" title="My academic papers and patents">Papers</a></li> <li ><a href="/pets.html" title="My loved pet projects">Pets</a></li> <li ><a href="/award.html" title="Software quality award">Award</a></li> <li ><a href="/testimonials.html" title="What some people say about me">Testimonials</a></li> <li ><a href="/shift-m.html" title="Audio podcast about project management">Shift-M</a></li> <li ><a href="/paintings.html" title="My paintings for sale">Art</a></li> <li><a href="https://ru.yegor256.com/" title="Немного на русском языке о политике в России, Украине и мире">Политика</a></li></ul></nav><div class="search"> <form method="get" action="https://www.google.com/search" itemprop="potentialAction" itemscope="" itemtype="http://schema.org/SearchAction"> <meta itemprop="target" content="https://www.google.com/search?q={q}"/> <input name="sitesearch" value="yegor256.com" type="hidden"/> <input itemprop="query-input" type="text" id="search-query" class="field field-text" required="required" onfocus="$('.google').css('visibility', 'visible');" name="q" placeholder="Search..." autocomplete="off"/> <input type="image" src="/images/google-search-icon.svg" class="google" title="Search via Google" alt="Search via Google"/> </form></div><div class="hot"><ul></ul></div></header></div><section itemscope="" itemtype="http://schema.org/BlogPosting"><div class="wrapper"> <header><h1 itemprop="name headline mainEntityOfPage">Do You Test Ruby Code for Thread Safety?</h1></header> <article class="main" itemprop="articleBody" style="font-family: sans-serif; font-size: 0.9em; line-height: 1.2em;"><p style="color: #C42C00;">The following text is a <em>partial</em> translation of the <a href='https://www.yegor256.com/2018/11/06/ruby-threads.html'>original English article</a>, performed by <a href="https://chat.openai.com/">ChatGPT</a> (gpt-3.5-turbo) and <a href="https://github.com/yegor256/jekyll-chatgpt-translate">this Jekyll plugin</a>:</p><p>你是Ruby开发者吗？如果是的话，我相信你对并发性和线程安全性有一个非常模糊的概念。无意冒犯，但这是我在过去半年里处理Ruby代码和与Ruby程序员交谈后得出的结论。最近我一直在积极地使用Ruby进行编写，我确实喜欢这门语言及其周围的生态系统。我们正在创建的实验性加密货币Zold几乎完全使用Ruby编写。这告诉你什么？我喜欢Ruby。但是当涉及到并发性时，还存在空白点。非常明显。</p><p>看这个Ruby类：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'sinatra'
class Front &lt; Sinatra::Base
  configure do
    IO.write('idx.txt', '0')
  end
  get '/' do
    idx = IO.read('idx.txt').to_i + 1
    IO.write('idx.txt', idx.to_s)
    idx.to_s
  end
end
Front.run!
</code></pre></div></div><p>这是一个简单的网页服务器。它会工作—尝试像这样运行它（你需要安装 Ruby 2.3+）：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ gem install sinatra
$ ruby server.rb
</code></pre></div></div><p>然后，打开 <code class="language-plaintext highlighter-rouge">http://localhost:4567</code>，你会看到计数器。刷新页面，计数器会递增。再试一次。它有效。计数器位于<code class="language-plaintext highlighter-rouge">idx.txt</code>文件中，它本质上是一个全局变量，我们在每个HTTP请求上递增它。</p><p>让我们为此创建一个单元测试，以确保它能够自动进行测试。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'minitest/autorun'
require 'net/http'
require 'uri'
class FrontTest &lt; Minitest::Test
  def test_works
    front = Thread.start do
      Front.run!
    end
    sleep 1
    count = Net::HTTP.get(URI('http://localhost:4567/')).to_i
    assert_equal(1, count)
    Front.stop!
  end
end
</code></pre></div></div><p>好的，这不是一个单元测试，而更像是一个集成测试。首先，我们在一个后台线程中启动一个Web服务器。然后，我们等待一秒钟，以给该线程足够的时间来引导服务器。我知道，这是一个非常丑陋的方法，但对于这个小例子，我没有更好的办法。接下来，我们发出一个HTTP请求并将其与预期的数字1进行比较。最后，我们停止Web服务器。</p><p>到目前为止一切都很好。现在问题是，当有许多请求发送到服务器时会发生什么？它是否仍然会返回正确的连续数字？让我们试一试：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def test_works
  front = Thread.start do
    Front.run!
  end
  sleep 1
  numbers = []
  1000.times do
    numbers &lt;&lt; Net::HTTP.get(URI('http://localhost:4567/')).to_i
  end
  assert_equal(1000, numbers.uniq.count)
  Front.stop!
end
</code></pre></div></div><p>在这里，我们发出了一千个请求，并将所有返回的数字放入一个数组中。然后我们对数组进行 <code class="language-plaintext highlighter-rouge">uniq</code> 操作，并对其元素进行 <code class="language-plaintext highlighter-rouge">count</code> 操作。如果有一千个元素，说明一切正常，我们收到了一个连续且唯一的数字列表。我刚刚测试过，它可行。</p><p>但是我们正在逐一制作它们，这就是为什么我们的服务器没有任何问题。我们没有同时制作它们。它们严格按照一个接一个的顺序进行。让我们尝试使用一些额外的线程来模拟HTTP请求的并行执行。</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'concurrent/set'
def test_works
  front = Thread.start do
    Front.run!
  end
  sleep 1
  numbers = Concurrent::Set.new
  threads = []
  5.times do
    threads &lt;&lt; Thread.start do
      200.times do
        numbers &lt;&lt; Net::HTTP.get(URI('http://localhost:4567/')).to_i
      end
    end
  end
  threads.each { |t| t.join }
  assert_equal(1000, numbers.to_a.count)
  Front.stop!
end
</code></pre></div></div><p>首先，我们将数字列表保存在<a href="http://ruby-concurrency.github.io/concurrent-ruby/master/Concurrent/Set.html"><code class="language-plaintext highlighter-rouge">Concurrent::Set</code></a>中，它是Ruby <a href="http://ruby-doc.org/stdlib-2.4.0/libdoc/set/rdoc/Set.html"><code class="language-plaintext highlighter-rouge">Set</code></a>的线程安全版本。其次，我们启动五个后台线程，每个线程发起200个HTTP请求。它们都并行运行，我们通过在每个线程上调用<code class="language-plaintext highlighter-rouge">join</code>来等待它们完成。最后，我们从Set中取出数字，并验证列表的正确性。</p><p>毫不意外，它失败了。</p><p>当然，你知道原因。因为该实现不是<em>线程安全</em>的。当一个线程正在读取文件时，另一个线程正在写入。最终，很快它们会发生冲突，导致文件内容损坏。我们在测试中加入的线程越多，结果就越不准确。</p><p>为了使这种类型的测试更容易，我创建了<a href="https://github.com/yegor256/threads">threads</a>，一个简单的Ruby gem。它的工作原理如下：</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>require 'threads'
def test_works
  front = Thread.start do
    Front.run!
  end
  sleep 1
  numbers = Concurrent::Set.new
  Threads.new(5).assert(1000) do
    numbers &lt;&lt; Net::HTTP.get(URI('http://localhost:4567/')).to_i
  end
  assert_equal(1000, numbers.to_a.count)
  Front.stop!
end
</code></pre></div></div><p>就是这样。这一行代码 <code class="language-plaintext highlighter-rouge">Threads.new()</code> 取代了所有其他代码行，我们不再需要创建线程、确保它们同时开始运行，然后收集它们的结果，并确保在控制台上显示它们的堆栈跟踪（默认情况下，后台线程的错误日志不可见）。</p><p>在你的项目中尝试使用这个宝石吧，它已经经过了相当充分的测试，并且我在所有并发测试中都使用它。</p><p class="jekyll-chatgpt-translate">Translated by ChatGPT gpt-3.5-turbo/33 on 2023-09-05 at 11:15</p></article></div><div class="wrapper"> <footer class="footer"><p> &copy; <span itemscope="" itemprop="copyrightHolder" itemtype="http://schema.org/Person"> <span itemprop="name">Yegor Bugayenko</span> </span> 2014&ndash;<span itemprop="copyrightYear">2023</span></p></footer></div></section><div class="wrapper unprintable" style="text-align:center;margin-top:2em;"> <a href="https://www.sixnines.io/h/3ba1652f"> <img src="//www.sixnines.io/b/3ba1652f?style=flat" alt="sixnines availability badge" /></a> &nbsp; <a href="https://github.com/yegor256/blog/stargazers"> <img src="//img.shields.io/github/stars/yegor256/blog.svg?style=flat-square" alt="GitHub stars" /></a></div><script src="//code.jquery.com/jquery-1.9.0.min.js"></script> <script src="/js/all.js?f8c5f5e211e"></script> <script>var disqus_shortname = 'yegor256';</script> <script id="dsq-count-scr" src="//yegor256.disqus.com/count.js" async="async"></script> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-1963507-32', 'auto'); ga('send', 'pageview'); </script> <script> Cd=document;Cr="&"+Math.random();Cp="&s=1"; Cd.cookie="b=b";if(Cd.cookie)Cp+="&c=1"; Cp+="&t="+(new Date()).getTimezoneOffset(); if(self!=top)Cp+="&f=1"; </script> <script> if(navigator.javaEnabled())Cp+="&j=1"; </script> <script> if(typeof(screen)!='undefined')Cp+="&w="+screen.width+"&h="+ screen.height+"&d="+(screen.colorDepth?screen.colorDepth:screen.pixelDepth); </script> <script> Cd.write("<img src='//c.hit.ua/hit?i=95870&g=0&x=2"+Cp+Cr+ "&r="+escape(Cd.referrer)+"&u="+escape(window.location.href)+ "' border='0' wi"+"dth='1' he"+"ight='1'/>"); </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Person", "name": "Yegor Bugayenko", "url": "https://www.yegor256.com", "sameAs": [ "https://www.facebook.com/yegor256", "https://instagram.com/yegor256", "https://www.linkedin.com/in/yegor256", "https://twitter.com/yegor256", "https://github.com/yegor256", "https://www.pinterest.com/yegor256/" ] } </script> </body> </html>
